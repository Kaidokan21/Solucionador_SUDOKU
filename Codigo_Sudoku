#include <stdio.h>

int inserir_grelha();
int validar_grelha();
int resolver_celula(int linha, int coluna);
int validar(int linha, int coluna, int valor);

void print_grelha();

int original[9][9], grelha[9][9];

int main()
{
	if (! inserir_grelha()) {
		printf("Erro: incapaz de inserir grelha...\n");
		return 0;
	}

	printf("\nA validar puzzle... \n");
	if (! validar_grelha()) {
		printf("Invalido!\n");
		return 0;
	}

	printf("Valido!\n\nresolvendo puzzle:\n");
	print_grelha();

	if (! resolver_celula(0, 0)) {
		printf("\ninfelizmente, o seu puzzle e' impossivel de resolver...\n");
		return 0;
	}

	printf("\nPuzzle Solucionado:\n");
	print_grelha();
	return 0;
}

int inserir_grelha()
{
	int caractere, linha, coluna;
	linha = coluna = 0;

	printf("Inserir linhas, linha por linha. Utilize numeros para celulas conhecidas, zeros ou pontos para celulas desconhecidas.\n\nLinha 1: ");

	while (linha < 9) {
		caractere = getchar();

		if ('0' <= caractere && caractere <= '9' || caractere == '.') {
			if (coluna > 8) {
				printf("Erro: cada linha tem no maximo 9 celulas...\n");
				return 0;
			}

			if (caractere != '.')
				original[linha][coluna] =
					grelha[linha][coluna] = caractere - '0';

			coluna++;

		} else if (caractere == '\n') {
			coluna = 0;
			linha++;

			printf("Linha %i: ", linha + 1);
		}
	}

	return 1;
}

int validar_grelha()
{
	int i, j;

	for (i = 0; i < 9; i++)
		for (j = 0; j < 9; j++)
			if (grelha[i][j])
				if (! validar(i, j, grelha[i][j]))
					return 0;

	return 1;
}

int resolver_celula(int linha, int coluna)
{
	int numero = 1;

	if (coluna == 9) {
		coluna = 0;
		linha++;
	}

	if (linha == 9)
		return 1;

	while (numero < 10) {
		if (validar(linha, coluna, numero)) {
			grelha[linha][coluna] = numero;

			if (resolver_celula(linha, coluna + 1))
				return 1;
		}

		grelha[linha][coluna] = 0;

		numero++;
	}

	return 0;
}

int validar(int linha, int coluna, int valor)
{
	int i, j, l, c;

	if (original[linha][coluna] != 0)
		if (original[linha][coluna] != valor)
			return 0;

	for (i = 0; i < 9; i++) {
		if (i != coluna)
			if (grelha[linha][i] == valor)
				return 0;

		if (i != linha)
			if (grelha[i][coluna] == valor)
				return 0;
	}

	l = (linha / 3) * 3;
	c = (coluna / 3) * 3;
	for (i = l; i < l + 3; i++)
		for (j = c; j < c + 3; j++)
			if (i != linha || j != coluna)
				if (grelha[i][j] == valor)
					return 0;

	return 1;
}

void print_grelha()
{
	int i, j;

	for (i = 0; i < 10; i++) {
		if (i % 3 == 0)
			printf("+-------+-------+-------+\n");

		if (i == 9)
			return;

		for (j = 0; j < 9; j++) {
			if (j % 3 == 0)
				printf("| ");

			grelha[i][j] != 0 ? printf("%d ", grelha[i][j]) : printf(". ");
		}

		printf("|\n");
	}
}
